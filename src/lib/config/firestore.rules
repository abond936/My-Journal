rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isValidTimestamp(ts) {
      return ts is timestamp && ts <= request.time;
    }
    
    function isValidTag() {
      let data = request.resource.data;
      return data.keys().hasAll(['name', 'type']) &&
             data.name is string && data.name.size() > 0 &&
             data.type in ['story', 'photo'] &&
             (!('category' in data) || data.category is string);
    }

    function isValidEntry() {
      let data = request.resource.data;
      return data.keys().hasAll(['title', 'content', 'tags', 'createdAt', 'updatedAt', 'type', 'status', 'date']) &&
             data.title is string && data.title.size() > 0 &&
             data.content is string &&
             data.tags is list &&
             data.createdAt is timestamp &&
             data.updatedAt is timestamp &&
             data.type in ['story', 'reflection'] &&
             data.status in ['draft', 'published'] &&
             data.date is timestamp &&
             (!('media' in data) || data.media is list) &&
             (!('visibility' in data) || data.visibility in ['private', 'family', 'public']);
    }
    
    // Tags collection
    match /tags/{tagId} {
      allow read, write: if true;  // Allow all access during development
    }
    
    // Entries collection
    match /entries/{entryId} {
      allow read, write: if true;  // Allow all access during development
    }
    
    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
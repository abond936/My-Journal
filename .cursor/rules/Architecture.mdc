---
description: Core architectural decisions and implementation rules for the journal application
globs: 
alwaysApply: true
---
# Project Vision Alignment

- **Core Vision:** The primary goal of this project is to create a seamless platform for capturing life stories for easily sharing with family and friends. Always prioritize features and solutions that directly contribute to this goal.
- **User-Centricity:** Target users are story authors themselves, who are not computer experts, but rather people interested in sharing their life stories with their family and friends, and those family and friends that desire a seamless, effortless way to consume this content. All decisions should consider their needs, pain points, and expected experience.
- **Key Value Propositions:** The key value proposition we aim to deliver are ease of use and enjoyable immerse experience without the intrusion of glitchy technology.
- **Avoid Feature Creep:** When implementing new features or making changes, always evaluate if they align with the core vision and avoid adding unnecessary complexity that doesn't directly serve the primary user needs.
- **Reference Vision Document:** For a detailed understanding of the project vision, refer to @./docs/VISION.md.

# My Journal Application Architecture

## CRITICAL RULES

### Rule 1: Always Check Existing Resources
- ALWAYS check for existing files, directories, and documentation BEFORE creating new ones
- NEVER create duplicate files or documentation
- ALWAYS search the codebase for existing implementations before adding new ones
- ALWAYS check the Architecture.mdc for existing definitions and patterns

### Rule 2: Architecture-Driven Development
- EVERY change MUST be supported by and documented in Architecture.mdc
- NO new components, types, or services should be created without first being defined in Architecture.mdc
- Architecture.mdc MUST be updated whenever changes are made to the codebase
- ALL development decisions must align with the architecture defined in Architecture.mdc

## 1. System Overview
- **Purpose**: A personal journaling application that helps users document and share their life stories and reflections, illustrated with photos and media.
- **Scope**: 
  - Story and reflection creation and management
  - Photo and media integration
  - Tag-based organization
  - Family sharing and interaction
  - AI-assisted content creation and organization
- **Technical Stack**:
  - Frontend: Next.js 14, React, Tailwind CSS
  - Backend: Firebase (Firestore, Authentication, Storage)
  - AI: OpenAI integration for content assistance
  - Media: Google Photos API (primary), with future support for Apple Photos
  - Hosting: Netlify (primary), with Vercel as backup
  - Version Control: GitHub
- **Deployment Model**: 
  - Netlify for hosting and CI/CD
  - GitHub for source control and collaboration
  - Firebase for backend services
  - Google Photos integration for media

## 2. Core Data Models

### Entry
- Primary content unit (replaces "Story" concept)
- Types:
  - Story: Narrative content with chronological elements
  - Reflection: Personal insights and observations
  - About: Special system entry (no tags, navbar access only)
- Properties:
  - Type (story/reflection/about)
  - Title
  - Content (Rich text with image markers)
  - Metadata:
    - Date
    - Author
    - Last modified
    - Status (draft/published)
    - View count
    - Media attachments
  - Tags (multi-dimensional, not applicable for About type)
  - Creation/update timestamps

### Data Services
- Location: `src/lib/data/`
- Core Services:
  - `entryService.ts`: Entry CRUD operations
    - Collection: 'entries'
    - Functions:
      - getAllEntries(): Promise<Entry[]>
      - getEntry(id: string): Promise<Entry | null>
      - saveEntry(entry: Entry): Promise<void>
      - deleteEntry(id: string): Promise<void>
      - updateEntryContent(id: string, content: string): Promise<void>
  - `firebase.ts`: Firebase configuration and initialization
    - Location: `src/lib/config/firebase/`
    - Files:
      - `admin.ts`: Firebase Admin SDK configuration
      - `client.ts`: Firebase client configuration
      - `rules.ts`: Firestore security rules
    - Uses environment variables for all credentials
    - Required environment variables:
      - NEXT_PUBLIC_FIREBASE_API_KEY
      - NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN
      - NEXT_PUBLIC_FIREBASE_PROJECT_ID
      - NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET
      - NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID
      - NEXT_PUBLIC_FIREBASE_APP_ID
    - Security: Never commit Firebase credentials to version control
  - `tagService.ts`: Tag management operations
  - `mediaService.ts`: Media handling operations

### Story (Entry Type)
- Narrative-focused entry type
- Inherits all Entry properties
- Additional properties:
  - Chronological elements
  - Event-based structure
  - Narrative flow
  - Story-specific templates

### Reflection (Entry Type)
- Insight-focused entry type
- Inherits all Entry properties
- Additional properties:
  - Theme-based organization
  - Personal insights
  - Learning points
  - Reflection-specific templates

### About (Entry Type)
- System-level entry type
- Properties:
  - Title
  - Content
  - Media attachments
  - No tags
  - Special access pattern (navbar/hamburger only)
  - Filtered from normal entry listings

### Tag System
- Multi-dimensional tagging system
- Dimensions:
  - Who: People and relationships
  - What: Activities and events
  - When: Time periods and life stages
  - Where: Locations and places
- Properties:
  - Name
  - Dimension
  - Parent tag (for hierarchy)
  - Order
  - Entry count
  - Path (for easy querying)
  - Entry type support (story/reflection only)
  - Selected tags (user-chosen)
  - Inherited tags (automatically included)
- Special Cases:
  - About entry is excluded from tagging system
  - Filters must ignore About entry in normal listings

### Media
- Photo and video management
- Properties:
  - URL
  - Caption
  - Order
  - Source (Google Photos, local, cloud)
  - Metadata (width, height, size, format)
  - Associated entry type
  - Entry reference
  - Tags (for organization)

### User
- Authentication and authorization
- Properties:
  - Authentication status
  - Role (Author/Family)
  - Preferences
  - View history
  - Life stage settings
  - Entry type preferences
  - Tag preferences

## 3. Scripts and Utilities

### Script Organization
- Location: `src/lib/scripts/`
- Categories:
  - `firebase/`: Firebase-related scripts
    - Backup and restore
    - Migration tools
    - Configuration management
  - `tags/`: Tag management scripts
    - Tag cleanup
    - Tag migration
    - Tag updates
  - `entries/`: Entry management scripts
    - Entry updates
    - Entry restoration
    - Entry comparison
  - `utils/`: Utility scripts
    - Codebase backup
    - CSV import/export
    - Testing utilities
  - `migration/`: Migration scripts
    - Data migration
    - Schema updates
    - Version management

### Configuration Management
- Location: `src/lib/config/`
- Categories:
  - `firebase/`: Firebase configuration
    - `admin.ts`: Admin SDK configuration
    - `client.ts`: Client SDK configuration
    - `rules.ts`: Security rules
  - `app/`: Application configuration
    - Environment variables
    - Feature flags
    - Constants

### Data Management
- Location: `src/data/`
- Categories:
  - `migration/`: Migration data
    - `firebase/`: Firebase migration data
    - `tags/`: Tag migration data
    - `entries/`: Entry migration data
  - `exports/`: Export data
    - CSV exports
    - JSON exports
    - Backup files

### Style Management
- Location: `src/lib/styles/`
- Categories:
  - `components/`: Component styles
    - Common components
    - Feature components
    - Layout components
  - `layouts/`: Layout styles
    - Page layouts
    - Section layouts
    - Grid layouts
  - `globals.css`: Global styles
    - Variables
    - Reset
    - Utilities

## 4. Component Organization

### Component Structure
- Location: `src/components/`
- Categories:
  - `common/`: Common components
    - Editor components
    - Layout components
    - Navigation components
  - `features/`: Feature components
    - Entry components
    - Tag components
    - Media components
  - `layouts/`: Layout components
    - Page layouts
    - Section layouts
    - Grid layouts
  - `navigation/`: Navigation components
    - Main navigation
    - Sidebar navigation
    - Tag navigation
  - `deprecated/`: Deprecated components
    - Old components
    - Migration documentation
    - README.md

### Component Guidelines
- Use functional components with hooks
- Implement proper TypeScript types
- Follow consistent naming conventions
- Document component props and usage
- Implement error boundaries
- Add loading states
- Follow accessibility guidelines

## 5. Testing Strategy

### Test Organization
- Location: `src/__tests__/`
- Categories:
  - `unit/`: Unit tests
    - Component tests
    - Service tests
    - Utility tests
  - `integration/`: Integration tests
    - API tests
    - Feature tests
    - Flow tests
  - `e2e/`: End-to-end tests
    - User flows
    - Critical paths
    - Edge cases

### Test Guidelines
- Use Jest for unit and integration tests
- Use Cypress for end-to-end tests
- Follow AAA pattern (Arrange, Act, Assert)
- Mock external dependencies
- Test error cases
- Test edge cases
- Maintain test coverage

## 6. Documentation

### Documentation Structure
- Location: `docs/`
- Categories:
  - `migration/`: Migration documentation
    - Migration plan
    - Migration status
    - Migration guides
  - `architecture/`: Architecture documentation
    - System overview
    - Data models
    - Component structure
  - `development/`: Development documentation
    - Setup guide
    - Contribution guide
    - Code style guide
  - `api/`: API documentation
    - Endpoints
    - Authentication
    - Error handling

### Documentation Guidelines
- Keep documentation up to date
- Use clear and concise language
- Include code examples
- Document all public APIs
- Document all configuration options
- Document all environment variables
- Document all deployment steps